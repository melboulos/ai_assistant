[{"appcode":"function OnUpdate(doc, meta) {\n    log(\"ğŸ“¥ Event triggered for doc ID:\", meta.id);\n\n    // ğŸš« Skip if no old_data\n    if (!doc.old_data) {\n        log(\"âš ï¸ Skipping, no old_data present:\", meta.id);\n        return;\n    }\n\n    // ğŸš« Skip if already enriched (prevents infinite loops)\n    if (doc._enriched === true) {\n        log(\"âš ï¸ Skipping, doc already enriched:\", meta.id);\n        return;\n    }\n\n    // ğŸš« Skip if no sales_lead\n    if (!doc.sales_lead) {\n        log(\"âš ï¸ Skipping, not a sales_lead doc:\", meta.id);\n        return;\n    }\n\n    log(\"âœ… Processing sales lead doc:\", meta.id);\n\n    // Build payload for Flask\n    var payload = {\n        lead_id: meta.id,\n        sales_lead: doc.sales_lead,\n        old_data: doc.old_data\n    };\n\n    log(\"ğŸ“ Payload to Flask:\", JSON.stringify(payload));\n\n    var response;\n    try {\n        response = curl(\"POST\", flaskPost, {\n            path: \"/generate_summary\",\n            headers: { \"Content-Type\": \"application/json\" },\n            body: JSON.stringify(payload)\n        });\n\n        log(\"ğŸ“¡ Raw response from Flask:\", JSON.stringify(response));\n\n        // âœ… Parse safely (handle string or object)\n        var parsed;\n        try {\n            if (typeof response.body === \"string\") {\n                parsed = JSON.parse(response.body);\n            } else {\n                parsed = response.body; // already object\n            }\n        } catch (e) {\n            log(\"âŒ Failed to parse Flask response body:\", e, response.body);\n            return;\n        }\n\n        log(\"ğŸ§¾ Parsed Flask response body:\", JSON.stringify(parsed));\n\n        if (parsed.summary && parsed.recommendation) {\n            doc.summary = parsed.summary;\n            doc.recommendation = parsed.recommendation;\n            doc._enriched = true; // ğŸ‘ˆ prevents loop on re-update\n\n            try {\n                sourceBucket[meta.id] = doc; // upsert back to bucket\n                log(\"âœ… Updated document with summary + recommendation:\", meta.id);\n            } catch (e) {\n                log(\"âŒ Error saving document:\", e);\n            }\n        } else {\n            log(\"âŒ Missing summary or recommendation in Flask response\");\n        }\n\n    } catch (e) {\n        log(\"âŒ Error posting to Flask or parsing response:\", e);\n    }\n}\n\nfunction OnDelete(meta) {\n    // no-op\n}\n","depcfg":{"buckets":[{"alias":"sourceBucket","bucket_name":"sales_lead","scope_name":"_default","collection_name":"_default","access":"rw"}],"curl":[{"hostname":"http://host.docker.internal:5001","value":"flaskPost","auth_type":"no-auth","username":"","password":"","bearer_key":"","allow_cookies":true,"validate_ssl_certificate":false}],"source_bucket":"sales_lead","source_scope":"_default","source_collection":"_default","metadata_bucket":"event_log","metadata_scope":"_default","metadata_collection":"_default"},"version":"evt-7.6.6-6126-ee","enforce_schema":false,"handleruuid":969459668,"function_instance_id":"X67B51","appname":"AI_Assistant","settings":{"cursor_aware":false,"dcp_stream_boundary":"everything","deployment_status":false,"description":"","execution_timeout":60,"language_compatibility":"7.2.0","log_level":"INFO","n1ql_consistency":"none","num_timer_partitions":128,"processing_status":false,"timer_context_size":1024,"user_prefix":"eventing","worker_count":1},"function_scope":{"bucket":"sales_lead","scope":"_default"}}]